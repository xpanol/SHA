<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>MARKETING DIGITAL / DIGITAL MARKETING</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
<style>
:root{--gold:#F8AC10;--red:rgb(240,50,70);--brown:#9b835a}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;background:black;color:white;font-family:'Special Elite',monospace}
body{max-width:1000px;margin:50px auto;padding:20px}
h1{text-align:center;margin-bottom:20px;color:var(--gold)}
#buttonsContainer{display:flex;justify-content:center;gap:15px;margin-bottom:30px;flex-wrap:wrap}
button{font-family:'Special Elite',monospace;border:0px solid #fff;cursor:pointer}
#playAllButton,#playESButton,#playENButton,#resetAllButton{background:var(--gold);color:black;width:140px;height:45px;border-radius:5px;display:flex;align-items:center;justify-content:center;padding:0 5px}
#stopAllButton{background:#ff0000;color:white;width:140px;height:45px;border-radius:5px}
.player{display:flex;align-items:flex-start;gap:15px;margin-bottom:40px;cursor:pointer}
.player button{background:var(--gold);color:black;width:45px;height:45px;border-radius:50%;font-size:25px;display:flex;align-items:center;justify-content:center;margin-right:15px}
.karaoke-line{font-size:32px;display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:flex-start;padding-top:10px;text-align:left}
.word{transition:color .08s}
.completed{color:var(--brown)}

/* MODAL & RECORDING */
#fullscreenModal,#shadowingPause{display:none;position:fixed;left:0;top:0;width:100%;height:100%;justify-content:center;align-items:center;flex-direction:column;z-index:9998}
#fullscreenModal{background:black;padding:20px;overflow:auto;z-index:9999}
#fullscreenModal .karaoke-line{font-size:48px;gap:24px;max-width:90%;margin:0 auto 30px;white-space:pre-wrap;justify-content:center}
.fullscreen-audio-wrapper{display:flex;gap:30px;margin-top:25px;justify-content:center}
#fullscreenAudio{width:0;height:0;opacity:0}
#fullscreenClose,#modalPlayButton,#modalPrevButton,#modalNextButton,#pauseCloseButton,#pauseStopButton{font-family:'Special Elite',monospace;background:var(--gold);border:0px solid #fff;color:black;cursor:pointer}
#modalPlayButton,#modalPrevButton,#modalNextButton{width:70px;height:70px;border-radius:50%;font-size:32px;display:flex;align-items:center;justify-content:center}
#fullscreenClose{position:absolute;top:20px;right:20px;padding:5px 10px;border-radius:5px;font-size:24px}

/* Recording Buttons inside Modal */
#recordControls{display:flex;justify-content:center;gap:15px;margin-top:40px;flex-wrap:wrap;border-top:1px solid #444;padding-top:25px;width:100%}
#recordControls button{width:200px;height:45px;border-radius:5px;background:var(--gold);color:black;font-size:14px;font-weight:bold}
#recordControls button:disabled{background:#444;color:#888;cursor:not-allowed}
#recordPlayback{display:none}

#shadowingPause{background:rgba(0,0,0,.95);z-index:9998}
#pauseControls{position:absolute;top:20px;right:20px;display:flex;gap:10px}
#pauseCloseButton,#pauseStopButton{width:120px;padding:5px 10px;border-radius:5px;font-size:14px}
#pauseCloseButton{background:var(--gold);color:black}
#pauseStopButton{background:#ff0000;color:white}
#shadowingHeader{position:absolute;top:15%;width:100%;text-align:center;color:var(--gold);font-size:100px;line-height:1;font-weight:700}
#pauseLine{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;text-align:center;display:flex;flex-wrap:wrap;justify-content:center}
#pauseLine .completed{font-size:60px;color:white!important;margin-right:20px;margin-bottom:10px;display:inline-block}
#pauseTimer{position:absolute;bottom:15%;width:100%;text-align:center;font-size:100px;color:var(--gold)}

@media(max-width:480px){
  #fullscreenModal .karaoke-line{font-size:34px}
  #modalPlayButton,#modalPrevButton,#modalNextButton{width:65px;height:65px;font-size:30px}
  #pauseLine .completed{font-size:36px}
  #pauseTimer{font-size:60px;bottom:10%}
  #playAllButton,#playESButton,#playENButton,#resetAllButton,#stopAllButton{width:45%;font-size:14px}
  #recordControls button{width:100%}
}
</style>
</head>
<body>
<h1>MARKETING DIGITAL / DIGITAL MARKETING</h1>
<div id="buttonsContainer">
  <button id="playAllButton">‚ñ∂ PLAY ALL</button>
  <button id="playESButton">üá™üá∏ PLAY SPANISH</button>
  <button id="playENButton">üá∫üá∏ PLAY ENGLISH</button>
  <button id="resetAllButton">RESET ALL</button>
  <button id="stopAllButton" hidden>üõë STOP ALL</button>
</div>
<div id="players"></div>

<div id="shadowingPause" aria-hidden="true">
  <div id="pauseControls">
    <button id="pauseStopButton">üõë STOP SEQUENCE</button>
    <button id="pauseCloseButton">‚úñ NEXT</button>
  </div>
  <div id="shadowingHeader">SHA!DOWING PAUSE</div>
  <div id="pauseLine"></div>
  <div id="pauseTimer"></div>
</div>

<div id="fullscreenModal" aria-hidden="true">
  <button id="fullscreenClose">‚úñ</button>
  <div id="fullscreenContent"></div>
  <div class="fullscreen-audio-wrapper">
    <button id="modalPrevButton">‚óÄ</button>
    <button id="modalPlayButton">‚ñ∂</button>
    <button id="modalNextButton">‚ñ∂</button>
    <audio id="fullscreenAudio"></audio>
  </div>
  
  <div id="recordControls">
    <button id="startRecording">GRABAR / RECORD</button>
    <button id="stopRecording" disabled>DETENER / STOP</button>
    <button id="playRecording" disabled>REPRODUCIR / PLAY REC</button>
    <audio id="recordPlayback"></audio>
  </div>
</div>

<script>
const BASE_URL='https://raw.githubusercontent.com/xpanol/PLAYERS/main/';
const TRACK_COUNT=30;
const playersContainer=document.getElementById('players');
const sequenceAudio=new Audio();
let playerControls=[],activeSequenceList=[],isPlayingAll=false,currentTrackIndex=0,currentAudioPlaying=null,highlightRaf=null,pauseTimeout=null,countdownInterval=null,activePlayButton=null;

/* MediaRecorder Variables */
let mediaRecorder;
let audioChunks = [];
const startBtn = document.getElementById('startRecording');
const stopBtn = document.getElementById('stopRecording');
const playBtn = document.getElementById('playRecording');
const playback = document.getElementById('recordPlayback');

const el={
  shadowingPause:document.getElementById('shadowingPause'),
  pauseTimer:document.getElementById('pauseTimer'),
  pauseLine:document.getElementById('pauseLine'),
  pauseCloseButton:document.getElementById('pauseCloseButton'),
  pauseStopButton:document.getElementById('pauseStopButton'),
  modal:document.getElementById('fullscreenModal'),
  modalContent:document.getElementById('fullscreenContent'),
  modalAudio:document.getElementById('fullscreenAudio'),
  modalPlayButton:document.getElementById('modalPlayButton'),
  modalPrevButton:document.getElementById('modalPrevButton'),
  modalNextButton:document.getElementById('modalNextButton'),
  modalClose:document.getElementById('fullscreenClose'),
  stopAllButton:document.getElementById('stopAllButton')
};

function stopHighlight(){ if(highlightRaf){ cancelAnimationFrame(highlightRaf); highlightRaf=null } }
function clearSpanStyles(s){ s.classList.remove('completed'); s.removeAttribute('style') }
function scrollToCurrentTrack(i){ if(i>=0 && i<playerControls.length){ const div=playerControls[i].playBtn.closest('.player'); if(div) div.scrollIntoView({behavior:'smooth',block:'center'}) } }

function startHighlightForAudio(audio, spans){
  stopHighlight();
  if(!spans.length) return;
  const lastEnd = parseFloat(spans[spans.length-1].dataset.end) || 0;
  let running=true;
  function loop(){
    if(!running) return;
    const t = audio.currentTime || 0;
    for(const span of spans){
      const s = parseFloat(span.dataset.start) || 0;
      const e = parseFloat(span.dataset.end) || 0;
      span.classList.remove('completed');
      if(t >= s && t <= e){
        span.style.color = (span.dataset.type==='z') ? 'rgb(240,50,70)' : 'var(--gold)';
      } else {
        span.style.color = 'white';
      }
    }
    if(t >= lastEnd){
      running=false;
      stopHighlight();
      for(const sp of spans){ sp.classList.add('completed'); sp.removeAttribute('style') }
      return;
    }
    highlightRaf = requestAnimationFrame(loop);
  }
  highlightRaf = requestAnimationFrame(loop);
}

const order=[],orderES=[],orderEN=[];
for(let i=1;i<=TRACK_COUNT;i++){
  const num=String(i).padStart(3,'0');
  const es={audio:BASE_URL+num+'_es.mp3',json:BASE_URL+num+'_es.json',type:'es',id:`es_${num}`};
  const en={audio:BASE_URL+'Z'+num+'_en.mp3',json:BASE_URL+'Z'+num+'_en.json',type:'z',id:`en_${num}`};
  order.push(es,en); orderES.push(es); orderEN.push(en);
}
activeSequenceList = order;

async function loadKaraoke(audioFile,jsonFile,container,type){
  try{
    const res = await fetch(jsonFile);
    if(!res.ok) return;
    const data = await res.json();
    if(!data || !data.length) return;
    const playerDiv=document.createElement('div'); playerDiv.className='player';
    const controlsDiv=document.createElement('div'); controlsDiv.className='audio-container';
    const playBtn=document.createElement('button'); playBtn.textContent='‚ñ∂';
    controlsDiv.appendChild(playBtn);
    const karaokeDiv=document.createElement('div'); karaokeDiv.className='karaoke-line';
    const wordsArray=[];
    for(const item of data){
      const words=item.text.split(' ');
      const start=item.start.split(':').reduce((a,t)=>60*a+ +t,0);
      const end=item.end.split(':').reduce((a,t)=>60*a+ +t,0);
      const dur=end-start; const wdur=dur/words.length;
      words.forEach((w,j)=>{
        const span=document.createElement('span');
        span.textContent = w+' ';
        span.dataset.start=(start+j*wdur).toFixed(2);
        span.dataset.end=(start+(j+1)*wdur).toFixed(2);
        span.dataset.type = type;
        span.className='word';
        karaokeDiv.appendChild(span);
        wordsArray.push(span);
      });
    }
    playerDiv.appendChild(controlsDiv); playerDiv.appendChild(karaokeDiv); container.appendChild(playerDiv);
    const localAudio=new Audio(); localAudio.src=audioFile; localAudio.style.display='none'; playerDiv.appendChild(localAudio);
    localAudio.onplay = ()=>{ if(isPlayingAll) return; startHighlightForAudio(localAudio,wordsArray); currentAudioPlaying=localAudio; playBtn.textContent='‚ùö‚ùö' }
    localAudio.onpause = ()=>{ if(isPlayingAll) return; stopHighlight(); playBtn.textContent='‚ñ∂' }
    localAudio.onended = ()=>{ if(isPlayingAll) return; playBtn.textContent='‚ñ∂'; wordsArray.forEach(s=>{ s.classList.add('completed'); s.removeAttribute('style') }) }
    
    playerControls.push({playBtn,localAudio,wordsArray,src:audioFile});
  }catch(e){ console.error(e) }
}

async function loadAll(){ 
  for(const item of order) await loadKaraoke(item.audio,item.json,playersContainer,item.type);
  // Re-wire clicks after load
  playerControls.forEach((control,index)=>{
    control.playBtn.onclick=()=>{
      stopShadowingPause(); if(isPlayingAll) stopSequenceGlobally(); stopCurrentAudio(); currentTrackIndex=index; showModalAndPlay(index)
    };
  });
}
loadAll();

function stopCurrentAudio(){
  if(currentAudioPlaying){ currentAudioPlaying.pause(); playerControls.forEach(pc=>pc.playBtn.textContent='‚ñ∂'); currentAudioPlaying=null; stopHighlight() }
  sequenceAudio.pause();
}
function resetAllHighlights(){ playerControls.forEach(pc=>{ pc.wordsArray.forEach(clearSpanStyles); pc.playBtn.textContent='‚ñ∂' }) }

function resetRecordingUI() {
    if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    playback.src = '';
    playBtn.disabled = true;
    stopBtn.disabled = true;
    startBtn.disabled = false;
    startBtn.innerText = "GRABAR / RECORD";
}

function showModalAndPlay(index){
  stopShadowingPause(); if(isPlayingAll) stopSequenceGlobally(); stopCurrentAudio();
  currentTrackIndex = index; const item = order[index];
  scrollToCurrentTrack(currentTrackIndex);
  el.modal.style.display='flex'; el.modal.setAttribute('aria-hidden','false'); el.modalContent.innerHTML='';
  resetRecordingUI();

  const clone = document.createElement('div'); clone.className='karaoke-line';
  fetch(item.json).then(r=>r.json()).then(data=>{
    const spans=[];
    data.forEach(it=>{
      const words=it.text.split(' '); const start=it.start.split(':').reduce((a,t)=>60*a+ +t,0); const end=it.end.split(':').reduce((a,t)=>60*a+ +t,0); const dur=end-start; const wdur=dur/words.length;
      words.forEach((w,j)=>{ const span=document.createElement('span'); span.textContent=w+' '; span.dataset.start=(start+j*wdur).toFixed(2); span.dataset.end=(start+(j+1)*wdur).toFixed(2); span.dataset.type=item.type; span.className='word';
        const originalSpan = playerControls[index] && playerControls[index].wordsArray.find(s=>s.textContent===span.textContent); if(originalSpan && originalSpan.classList.contains('completed')) span.classList.add('completed');
        clone.appendChild(span); spans.push(span);
      })
    });
    el.modalContent.appendChild(clone);
    el.modalAudio.src=item.audio; el.modalAudio.currentTime=0; el.modalAudio.load();
    el.modalAudio.onplay = ()=>{ el.modalPlayButton.textContent='‚ùö‚ùö'; startHighlightForAudio(el.modalAudio,spans); currentAudioPlaying=el.modalAudio }
    el.modalAudio.onpause = ()=>{ el.modalPlayButton.textContent='‚ñ∂'; stopHighlight() }
    el.modalAudio.onended = ()=>{ el.modalPlayButton.textContent='‚ñ∂'; spans.forEach(s=>{ s.classList.add('completed'); s.removeAttribute('style') }) }
    el.modalAudio.play();
    
    el.modalPrevButton.onclick = ()=>{ if(currentTrackIndex>0){ currentTrackIndex--; showModalAndPlay(currentTrackIndex) } }
    el.modalNextButton.onclick = ()=>{ if(currentTrackIndex<order.length-1){ currentTrackIndex++; showModalAndPlay(currentTrackIndex) } }
    el.modalPlayButton.onclick = ()=>{ if(el.modalAudio.paused || el.modalAudio.ended) el.modalAudio.play(); else el.modalAudio.pause() }
  });
}

/* RECORDING LOGIC */
startBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        playback.src = URL.createObjectURL(blob);
        playBtn.disabled = false;
    };
    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
    startBtn.innerText = "GRABANDO... / RECORDING...";
};

stopBtn.onclick = () => {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.innerText = "RE-GRABAR / RE-RECORD";
};

playBtn.onclick = () => playback.play();

/* Original Global Controls Restored */
document.getElementById('playAllButton').onclick = ()=> startFilteredPlay(order, document.getElementById('playAllButton'));
document.getElementById('playESButton').onclick = ()=> startFilteredPlay(orderES, document.getElementById('playESButton'));
document.getElementById('playENButton').onclick = ()=> startFilteredPlay(orderEN, document.getElementById('playENButton'));
document.getElementById('resetAllButton').onclick = ()=> location.reload();

function stopSequenceGlobally(){
  stopShadowingPause(); stopCurrentAudio(); isPlayingAll=false;
  document.getElementById('playAllButton').textContent='‚ñ∂ PLAY ALL';
  document.getElementById('playESButton').textContent='üá™üá∏ PLAY SPANISH';
  document.getElementById('playENButton').textContent='üá∫üá∏ PLAY ENGLISH';
  el.stopAllButton.textContent='‚ñ∂ RESUME'; el.stopAllButton.style.background='var(--gold)'; el.stopAllButton.style.color='black'; el.stopAllButton.hidden=false;
}

function startFilteredPlay(list, buttonElement){
  stopShadowingPause(); stopCurrentAudio();
  if(el.stopAllButton.textContent==='‚ñ∂ RESUME' && activePlayButton===buttonElement){ resumeFromStopButton(); return }
  activeSequenceList = list; currentTrackIndex = 0; resetAllHighlights();
  isPlayingAll=true; activePlayButton=buttonElement;
  buttonElement.textContent='‚ùö‚ùö PAUSE';
  el.stopAllButton.textContent='üõë STOP ALL'; el.stopAllButton.style.background='#ff0000'; el.stopAllButton.style.color='white'; el.stopAllButton.hidden=false;
  playNextTrackSequence();
}

function playNextTrackSequence(){
  stopShadowingPause();
  if(!isPlayingAll) return;
  const currentTrackData = activeSequenceList[currentTrackIndex];
  if(currentTrackIndex < activeSequenceList.length){
    sequenceAudio.src = currentTrackData.audio;
    const overallIndex = order.findIndex(o=>o.audio===currentTrackData.audio);
    const trackData = playerControls[overallIndex];
    scrollToCurrentTrack(overallIndex);
    sequenceAudio.onplay = ()=>{ trackData.playBtn.textContent='‚ùö‚ùö'; startHighlightForAudio(sequenceAudio,trackData.wordsArray); currentAudioPlaying=sequenceAudio }
    sequenceAudio.onended = ()=>{
      trackData.playBtn.textContent='‚ñ∂';
      startShadowingPause(sequenceAudio.duration, trackData.wordsArray, overallIndex);
    };
    sequenceAudio.play();
  } else {
    stopSequenceGlobally();
    el.stopAllButton.hidden=true;
  }
}

function startShadowingPause(duration, wordsArray, overallIndex){
  el.pauseLine.innerHTML='';
  wordsArray.forEach(sp=>{ const c=sp.cloneNode(true); c.classList.add('completed'); c.removeAttribute('style'); c.textContent=c.textContent.trim(); el.pauseLine.appendChild(c) });
  let remaining=Math.ceil(duration*1.1);
  el.shadowingPause.style.display='flex'; el.pauseTimer.textContent=remaining;
  countdownInterval=setInterval(()=>{ remaining--; el.pauseTimer.textContent=remaining; if(remaining<=0) clearInterval(countdownInterval) },1000);
  pauseTimeout=setTimeout(()=>{ stopShadowingPause(); currentTrackIndex++; playNextTrackSequence() }, (duration*1.1)*1000);
}

function stopShadowingPause(){ clearTimeout(pauseTimeout); clearInterval(countdownInterval); el.shadowingPause.style.display='none' }

el.modalClose.onclick = ()=>{ el.modalAudio.pause(); resetRecordingUI(); el.modal.style.display='none' };
el.pauseStopButton.onclick = ()=> stopSequenceGlobally();
el.pauseCloseButton.onclick = ()=>{ stopShadowingPause(); currentTrackIndex++; playNextTrackSequence() };

</script>
</body>
</html>
